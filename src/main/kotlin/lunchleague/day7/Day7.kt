package org.example.lunchleague.day7

val hitSplitters = mutableSetOf<Pair<Int, Int>>()
val seenPositions = mutableSetOf<Pair<Int, Int>>()

val knownNumberOfTimelinesFromPoint = mutableMapOf<Pair<Int, Int>, Long>()

fun main() {

    val twoDeeMap = puzzleInput.split("\n").map { it.split("") }

    var start = Pair(0, 0)
    val splitters = mutableSetOf<Pair<Int, Int>>()

    twoDeeMap.forEachIndexed { j, line ->
        line.forEachIndexed { i, char ->
            when (char) {
                "S" -> start = Pair(i, j)
                "^" -> splitters.add(Pair(i, j))
            }
        }
    }

    part1(start, splitters)

    if (hitSplitters.size != 1662) throw Exception()

//    prettyPrint(twoDeeMap, splitters)

    val part2 = 1L + findTimelinesFrom(start, splitters)

    if (part2 != 40941112789504) throw Exception()
}

fun findTimelinesFrom(position: Pair<Int, Int>, splitters: MutableSet<Pair<Int, Int>>): Long {
    if (positionBelow(position).isOutsideTheManifold()) return 0

    if (position in knownNumberOfTimelinesFromPoint) {
        return knownNumberOfTimelinesFromPoint[position]!!
    }

    var tally = 0L
    if (positionBelow(position) in splitters) {
        tally += 1
        tally += findTimelinesFrom(positionBelowAndLeft(position), splitters)
        tally += findTimelinesFrom(positionBelowAndRight(position), splitters)
    } else {
        val howManyTimelinesFromThisPoint = findTimelinesFrom(positionBelow(position), splitters)
        knownNumberOfTimelinesFromPoint[position] = howManyTimelinesFromThisPoint
        tally += howManyTimelinesFromThisPoint
    }
    return tally
}

private fun prettyPrint(
    twoDeeMap: List<List<String>>,
    splitters: MutableSet<Pair<Int, Int>>,
) {
    twoDeeMap.indices.forEach { j ->
        twoDeeMap[0].indices.forEach { i ->
            if (Pair(i, j) in splitters) {
                print("^ ")
            } else if (Pair(i, j) in seenPositions) {
                print("| ")
            } else {
                print(". ")
            }
        }
        println()
    }
}

private fun part1(
    start: Pair<Int, Int>,
    splitters: Set<Pair<Int, Int>>,
) {
    findFrom(positionBelow(start), splitters)

    println("part1 = ${hitSplitters.size}")
}

private fun findFrom(position: Pair<Int, Int>, splitters: Set<Pair<Int, Int>>) {
    println("position = ${position}")
    println("splitters size = ${hitSplitters.size}")

    if (position in seenPositions) return
    seenPositions.add(position)

    if (positionBelow(position).isOutsideTheManifold()) return

    if (positionBelow(position) in splitters) {
        hitSplitters.add(positionBelow(position))
        findFrom(positionBelowAndLeft(position), splitters)
        findFrom(positionBelowAndRight(position), splitters)
    } else {
        findFrom(positionBelow(position), splitters)
    }
}

private fun Pair<Int, Int>.isOutsideTheManifold(): Boolean = this.second >= puzzleInput.split("\n").size

private fun positionBelow(start: Pair<Int, Int>): Pair<Int, Int> = Pair(start.first, start.second + 1)
private fun positionBelowAndLeft(start: Pair<Int, Int>): Pair<Int, Int> = Pair(start.first - 1, start.second + 1)
private fun positionBelowAndRight(start: Pair<Int, Int>): Pair<Int, Int> = Pair(start.first + 1, start.second + 1)

val input = """.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
..............."""

val puzzleInput = """......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^.^.^...................................................................
.............................................................................................................................................
..................................................................^...^.^.^..................................................................
.............................................................................................................................................
.................................................................^.^.^.....^.................................................................
.............................................................................................................................................
................................................................^.^...^.^...^................................................................
.............................................................................................................................................
...............................................................^...^.^.^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^...^.^.^.^...^..............................................................
.............................................................................................................................................
.............................................................^.^.^...^.^.^...^.^.............................................................
.............................................................................................................................................
............................................................^...^.^.^.^...^.^...^............................................................
.............................................................................................................................................
...........................................................^.^.^.^...^...^...^...^...........................................................
.............................................................................................................................................
..........................................................^.^.^.^...^.....^.^.^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^...^...^...^.^.^.....^.^.........................................................
.............................................................................................................................................
........................................................^.....^.^.^.^.^.^.^.^.^...^.^........................................................
.............................................................................................................................................
.......................................................^.^.^...^...^.....^...^.......^.......................................................
.............................................................................................................................................
......................................................^.^.^...^.......^.^.....^.^...^.^......................................................
.............................................................................................................................................
.....................................................^.^.^.^.....^.^.^.^...^.^...^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^.^.^.....^...^.^.^...^...^.^...^.^....................................................
.............................................................................................................................................
...................................................^.^...^.^.^.^.^.^.^.^...^.....^.^.^...^...................................................
.............................................................................................................................................
..................................................^.^.^.^.^...^.^.^.^.^.......^.^.^.^.^...^..................................................
.............................................................................................................................................
.................................................^.^.^.^.^.....^...^.^...^...^.^.^.^.^.^...^.................................................
.............................................................................................................................................
................................................^.^.^...^.^.^...^.^.......^.^.^.^.^.^.^.....^................................................
.............................................................................................................................................
...............................................^.^.^.^.^.....^...^.^...^...^.^.^.^.^.^...^.^.^...............................................
.............................................................................................................................................
..............................................^.....^.^...^.^.^.^.^...^.^.^.^.^.^.^.....^.^...^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^...^.....^...^.^...^.^.^.....^.....^...^.^.............................................
.............................................................................................................................................
............................................^.^.^.^.^.^.^.^.....^.......^.^.^.^.^...^.^...^.^...^............................................
.............................................................................................................................................
...........................................^...^...^.^.....^.^.^.^...^...^.^.^.^...^.^.^.......^.^...........................................
.............................................................................................................................................
..........................................^.^.^.^.^.^.^.^.^.^.....^...^.....^.^.^.^.^.^.^.^.^...^.^..........................................
.............................................................................................................................................
.........................................^.^.^.^.^.^.......^...^.^.^.^.^.^.^...^...^.^.^.^.^.^.^...^.........................................
.............................................................................................................................................
........................................^.........^.^.....^.^.^.^.^...^.^...........^...^.^.^...^.^.^........................................
.............................................................................................................................................
.......................................^.^.^.^...^.^.^...^.^...^.^...^.^...^.^...^...^.^.^.........^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^.....^.^.^.^.^.^.^...^.^.^.^.........^...^...........^.^......................................
.............................................................................................................................................
.....................................^...^.....^...^.^.^.....^.....^...^.^...^.^.^...^.^.^.^...^.^.^.^.^.....................................
.............................................................................................................................................
....................................^.^.^.^.^...^...^...^.........^.^.^.^.^.^.^.^.^.^...^.^...^.^.......^....................................
.............................................................................................................................................
...................................^.^...^...........^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...................................
.............................................................................................................................................
..................................^...^.^.^...^.....^.^.^...^.^.^.^.....^...^.^.^.....^.^...^.^.^...^.^.^.^..................................
.............................................................................................................................................
.................................^...^.^.^...^.^.^.^.^.^.^.^.^...^...^.^...^...^.....^...^...^.^...^.^...^.^.................................
.............................................................................................................................................
................................^.^.^.^...^.^.^...^.....^.^.....^...^...^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^................................
.............................................................................................................................................
...............................^...^.^...^.^.....^.^...^.^...^.^.^.......^.^.^.^...^...^.^.^.^.^.^.^.^...^.^.^...............................
.............................................................................................................................................
..............................^.^.^.^.^.^...^...^...^...^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^...^.^...^.^...^.^.^..............................
.............................................................................................................................................
.............................^.^.^.^.^.......^.^.^.....^.^.........^.^.^...^.^.^.^.^.^.^.^.^.^.^...^...^.^...^.^.............................
.............................................................................................................................................
............................^.^.^.^.^.^.^.^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.......^............................
.............................................................................................................................................
...........................^.^...^...^.^.^.^.^...^.^.^.^...^...^...^.^.^.^.^.^...^.^.^...^...^.^.^...^.^...^...^.^...........................
.............................................................................................................................................
..........................^.....^...^.....^.^.^.^...^.^.^...^...^.^...^.^.^.^...^.....^.^.^...^.^.^...^.^.^.^...^.^..........................
.............................................................................................................................................
.........................^.^.^...^.^.^.^.^.^.^.^.^.^.^.....^...^.^...^.^.^.^...^...^.....^.^.^.....^...^.^.^.^.^.^.^.........................
.............................................................................................................................................
........................^.^...^.^...^.^.^...^...^.^...^.^.^...^.^.^.^.^.^.^.^.^.^...^...^...^.^.^.^.^.^.^.^.^.^.^.^.^........................
.............................................................................................................................................
.......................^.^...^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^...^...^.^...^.^...^.^.^...^.^.^.........^...^.^.^...^.......................
.............................................................................................................................................
......................^.^.^.^...^...^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^...^.....^.^...^.^.....^.....^...^.^.^......................
.............................................................................................................................................
.....................^...^.^.^.....^.....^...^.....^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^.....^.^...^.^.^.....................
.............................................................................................................................................
....................^.^.^.^.^...^.....^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^...^...^.^.^.^.....^.^.....^.^.^.^.^.^....................
.............................................................................................................................................
...................^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^...^.^.^...^.......^.^.^.^.^.^.^.^.^.^...^.^.^.^...................
.............................................................................................................................................
..................^...^.^.^.^...^.^.^.^.....^...^.^.^.^.^.^...^...^.^.^...^...^.....^.^.^.^.....^...^.^...^...^.....^.^.^.^..................
.............................................................................................................................................
.................^.^...^...^.^.....^...^.^.^.^.^.^.^...^.^...^...^.^...^.^.^.^.^.^...^.^.....^.^.^.^...^.^.^.^...^.^.......^.................
.............................................................................................................................................
................^...^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.^.......^.^.^.^.^.^.^.....^.^.....^.^.^...^.^.^...^.^...^...^.^.^.^................
.............................................................................................................................................
...............^.^...^.^.^...^...^.^.^.^.....^.^.^...^...^.^.^.^.^...^.........^...^.^.^.^...^.^.^.^...^.^.^...^.^...^.^.^.^.^...............
.............................................................................................................................................
..............^.^...^.^.^...^...^.^.^.^.^.^.^.....^.^.^...^...^...^.^.^...^.....^...^.^.^.^.....^...^.....^...^.^.^.^.^.....^.^..............
.............................................................................................................................................
.............^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^.....^.^.^.^...^...^.^.^...^.^.^...........^.^.^...^.^.......^...^.^.^.^...^.............
.............................................................................................................................................
............^.^.^.^.......^.^.^.^.....^...^.^.^...^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.........^...^.^.^.^.^.^...^...^.^.^.^............
.............................................................................................................................................
...........^.^.^.^...^.^.^...^...^...^...^.^.^.^.^.^.^.^.^.^...^...^...^...^.^.^.^.^.^.....^.^.^.^.........^.^.^...^.^.^.^.....^.^...........
.............................................................................................................................................
..........^.^.^...^.^.^.^.^.^.^.^.....^.^.....^.^...^.^...^...^.^...^.^.^...^.^.^.^.^.^.^.....^...^.^.^.^.^.^.......^.^.^.^.^.^.^.^..........
.............................................................................................................................................
.........^...^.^...^.......^...^.^...^...^...^.^.^...^...^.^.^.^.^.....^.....^...^.^...^.^.^.^...^.^.^.^.^.....^.^...^.^.^.^...^.^.^.........
.............................................................................................................................................
........^.^.^.^.^.........^.....^.^.....^...^.......^.^.^.^.......^...^.^...^.^.^.^.^.^.^...^.^...^...^.......^.^.^.^.^.^.^.^...^...^........
.............................................................................................................................................
.......^.^.^.^...^...^.....^.^.^.....^.^.^.^.^.....^...^.^.^.^.^.^.....^.^.^.^...^.^.^.....^.......^.^.^...^.....^.^.^.^.^.^.^.^.....^.......
.............................................................................................................................................
......^.^.^.^.^.^.^.^.^.^.^.^.....^...^.^.^.^.^.^...^.^...^...^...^...^.^.^.^...^...^...^.^.....^.^...^.^.^.^.^...^.....^.^...^.^.^.^.^......
.............................................................................................................................................
.....^...^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.^.^.....^.^...^.^.^.^.^...^.^.^...^.^...^.....^...^.^.^.^.^.^.^.^.^...^.....
.............................................................................................................................................
....^.^.^...^.^...^.^.^...^.^...^...^.^...^.^.^...^...^...^.^.^.^.^.^.^.^.^.^.....^.^...........^...^.^.^.^.^...^.^...^.^.^...^...^.^.^.^....
.............................................................................................................................................
...^.^.^...^.^...^...^.^.^.^...^.^.^.^.^.^.^.^...^.^.......^.^.....^.^.^...^.^.^.^.^.^.^.^.^.^.........^.^.^.^...^.^.^.^.^.^.^...^.^.^...^...
.............................................................................................................................................
..^.^.^.^.^.^.^.^.^.^...^...^.....^...^.^.^.^...^...^.^...^.^.^.^.^...^.^.^...^.^.^.......^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^...^.^.^.....^..
.............................................................................................................................................
.^.^.^.^.^.^...^.^.^.^.^...^.^...^.^...^.^.^...^.^.^...^.^.^.^.^.....^.^.......^.^.^.^.^.^.....^...^.^.^.^.^.^.^.^...^.^.^.....^.^...^.^...^.
............................................................................................................................................."""
